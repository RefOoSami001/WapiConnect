<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WapiConnect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">

</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-whatsapp"></i>WapiConnect
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-tabs">
                    <a href="#" class="navbar-tab active" data-bs-toggle="tab" data-bs-target="#sessions">
                        <i class="bi bi-phone"></i>Sessions
                    </a>
                    <a href="#" class="navbar-tab" data-bs-toggle="tab" data-bs-target="#bulk-messaging">
                        <i class="bi bi-send"></i>Bulk Messaging
                    </a>
                    <a href="#" class="navbar-tab" data-bs-toggle="tab" data-bs-target="#contacts">
                        <i class="bi bi-people"></i>Contacts
                    </a>
                    <a href="#" class="navbar-tab" data-bs-toggle="tab" data-bs-target="#api-docs">
                        <i class="bi bi-code-slash"></i>API Docs
                    </a>
                    <a href="#" class="navbar-tab" data-bs-toggle="tab" data-bs-target="#auto-reply-tab">
                        <i class="bi bi-reply-all-fill"></i>Auto-Reply
                    </a>
                </div>
                <ul class="navbar-nav ms-auto">

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-profile" href="#" id="userDropdown" role="button"
                            data-bs-toggle="dropdown">

                            <div class="user-info">
                                <span class="user-name" id="user-name">User</span>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="bi bi-box-arrow-right"></i>Logout
                                </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>



    <!-- Tab Content -->
    <div class="tab-content" id="dashboardTabsContent">
        <!-- Sessions Tab -->
        <div class="tab-pane fade show active" id="sessions" role="tabpanel">
            <div class="session-stats">
                <div class="session-stat" style="flex: 2;">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div class="d-flex align-items-center">
                            <div class="session-stat-icon primary me-3">
                                <i class="bi bi-phone"></i>
                            </div>
                            <div class="session-stat-content">
                                <div class="session-stat-number" id="total-sessions">0</div>
                                <div class="session-stat-label">Total Sessions</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="session-stat-icon success me-3">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="session-stat-content">
                                <div class="session-stat-number" id="active-sessions">0</div>
                                <div class="session-stat-label">Active Sessions</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="session-stat" style="flex: 1; justify-content: flex-end;">
                    <button class="btn btn-primary" id="create-session-btn">
                        <i class="bi bi-plus-circle me-2"></i>New Session
                    </button>
                </div>
            </div>

            <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-2" id="sessions-container">
                <!-- Sessions will be loaded here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state d-none">
                <i class="bi bi-whatsapp empty-state-icon"></i>
                <h3 class="empty-state-title">No WhatsApp Sessions</h3>
                <p class="empty-state-text">Create your first WhatsApp session to get started</p>
                <button class="btn btn-primary" onclick="document.getElementById('create-session-btn').click()">
                    <i class="bi bi-plus-lg me-2"></i>Create Session
                </button>
            </div>
        </div>

        <!-- Bulk Messaging Tab -->
        <div class="tab-pane fade" id="bulk-messaging" role="tabpanel">
            <div class="bulk-messaging-container">
                <div class="bulk-messaging-header">
                    <div class="bulk-messaging-icon">
                        <i class="bi bi-send"></i>
                    </div>
                    <div>
                        <h4 class="bulk-messaging-title">Bulk Messaging</h4>
                        <p class="bulk-messaging-subtitle">Send messages to multiple recipients at once</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="session-selection">
                            <h5 class="session-selection-title">
                                <i class="bi bi-phone"></i>Select Session
                            </h5>
                            <div id="session-radio-container">
                                <!-- Session radio buttons will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="message-form">
                            <h5 class="message-form-title">
                                <i class="bi bi-chat-text"></i>Message Details
                            </h5>
                            <form id="bulk-message-form">
                                <div class="mb-3">
                                    <label for="bulk-phone-numbers" class="form-label">Phone Numbers</label>
                                    <textarea class="form-control" id="bulk-phone-numbers" rows="3"
                                        placeholder="+1234567890&#10;+9876543210" required></textarea>
                                    <small class="text-muted">Enter each phone number on a new line with country
                                        code</small>
                                </div>
                                <div class="mb-3">
                                    <label for="bulk-message" class="form-label">Message</label>
                                    <textarea class="form-control" id="bulk-message" rows="3"
                                        placeholder="Enter your message here"></textarea>
                                </div>

                                <div class="image-upload-container">
                                    <div class="image-upload-header">
                                        <div class="image-upload-icon">
                                            <i class="bi bi-image"></i>
                                        </div>
                                        <h5 class="image-upload-title">Add Image (Optional)</h5>
                                    </div>

                                    <ul class="nav nav-tabs mb-3" id="bulkImageTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="bulk-url-tab" data-bs-toggle="tab"
                                                data-bs-target="#bulk-url" type="button" role="tab">Image
                                                URL</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="bulk-upload-tab" data-bs-toggle="tab"
                                                data-bs-target="#bulk-upload" type="button" role="tab">Upload
                                                File</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content" id="bulkImageTabsContent">
                                        <div class="tab-pane fade show active" id="bulk-url" role="tabpanel">
                                            <div class="mb-3">
                                                <input type="url" class="form-control" id="bulk-image-url"
                                                    placeholder="Enter image URL (e.g., https://example.com/image.jpg)">
                                                <button class="btn btn-outline-primary btn-sm mt-2" type="button"
                                                    id="bulk-preview-image">
                                                    <i class="bi bi-eye me-1"></i>Preview
                                                </button>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="bulk-upload" role="tabpanel">
                                            <div class="mb-3">
                                                <input type="file" class="form-control" id="bulk-image-file"
                                                    accept="image/*">
                                                <button class="btn btn-outline-primary btn-sm mt-2" type="button"
                                                    id="bulk-preview-upload">
                                                    <i class="bi bi-eye me-1"></i>Preview
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="bulk-image-preview" class="mt-3 d-none">
                                        <div class="text-center">
                                            <div class="image-preview">
                                                <img src="" alt="Preview" class="img-fluid">
                                            </div>
                                            <button type="button" class="btn btn-sm btn-danger mt-2"
                                                id="bulk-remove-image">
                                                <i class="bi bi-trash me-1"></i>Remove Image
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-send me-2"></i>Send Bulk Message
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contacts Tab -->
        <div class="tab-pane fade" id="contacts" role="tabpanel">
            <div class="bulk-messaging-container">
                <div class="bulk-messaging-header">
                    <div class="bulk-messaging-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <div>
                        <h4 class="bulk-messaging-title">Contact Management</h4>
                        <p class="bulk-messaging-subtitle">Pull contacts or group members from WhatsApp</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="session-selection">
                            <h5 class="session-selection-title">
                                <i class="bi bi-phone"></i>Select Session
                            </h5>
                            <div id="contacts-session-radio-container">
                                <!-- Session radio buttons will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="message-form">
                            <h5 class="message-form-title">
                                <i class="bi bi-person-lines-fill"></i>Contact Options
                            </h5>
                            <form id="contacts-form">
                                <div class="mb-3">
                                    <label class="form-label">Contact Source</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check contact-source-radio">
                                            <input class="form-check-input" type="radio" name="contactSource"
                                                id="contacts-source" value="contacts" checked>
                                            <label class="form-check-label" for="contacts-source">
                                                <i class="bi bi-person me-1"></i>Contacts
                                            </label>
                                        </div>
                                        <div class="form-check contact-source-radio">
                                            <input class="form-check-input" type="radio" name="contactSource"
                                                id="groups-source" value="groups">
                                            <label class="form-check-label" for="groups-source">
                                                <i class="bi bi-people me-1"></i>Groups
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Remove the options sections since they'll be enabled by default -->
                                <div class="d-grid mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-download me-2"></i>Pull Contacts
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div id="contacts-results" class="message-form mt-4 d-none">
                            <h5 class="message-form-title">
                                <i class="bi bi-table"></i>Results
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Phone Number</th>
                                            <th>Name</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contacts-table-body">
                                        <!-- Results will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-outline-primary" id="copy-contacts">
                                    <i class="bi bi-clipboard me-2"></i>Copy All
                                </button>
                                <button class="btn btn-outline-primary" id="export-contacts">
                                    <i class="bi bi-file-earmark-excel me-2"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auto-Reply Tab -->
        <div class="tab-pane fade" id="auto-reply-tab" role="tabpanel">
            <div class="container-fluid py-4">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-reply-all-fill me-2 text-primary"></i>Auto-Reply Rules
                                </h5>
                                <button class="btn btn-primary" id="create-rule-btn">
                                    <i class="bi bi-plus-lg me-1"></i>Create Rule
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Session</th>
                                                <th>Trigger</th>
                                                <th>Response</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="auto-reply-rules-table">
                                            <!-- Rules will be loaded here -->
                                            <tr>
                                                <td colspan="6" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Docs Tab -->
        <div class="tab-pane fade" id="api-docs" role="tabpanel">
            <div class="api-docs-container">
                <div class="api-docs-header">
                    <div class="api-docs-icon">
                        <i class="bi bi-code-slash"></i>
                    </div>
                    <div>
                        <h4 class="api-docs-title">API Documentation</h4>
                        <p class="api-docs-subtitle">Integrate WhatsApp messaging into your applications</p>
                    </div>
                </div>

                <div class="api-docs-nav mb-4">
                    <div class="nav nav-pills" id="api-tabs" role="tablist">
                        <button class="nav-link active" id="auth-tab" data-bs-toggle="pill"
                            data-bs-target="#auth-content" type="button" role="tab">
                            <i class="bi bi-shield-lock me-2"></i>Authentication
                        </button>
                        <button class="nav-link" id="sessions-tab" data-bs-toggle="pill"
                            data-bs-target="#sessions-content" type="button" role="tab">
                            <i class="bi bi-phone me-2"></i>Sessions
                        </button>
                        <button class="nav-link" id="messaging-tab" data-bs-toggle="pill"
                            data-bs-target="#messaging-content" type="button" role="tab">
                            <i class="bi bi-send me-2"></i>Messaging
                        </button>
                        <button class="nav-link" id="contacts-tab" data-bs-toggle="pill"
                            data-bs-target="#contacts-content" type="button" role="tab">
                            <i class="bi bi-people me-2"></i>Contacts
                        </button>
                    </div>
                </div>

                <div class="tab-content" id="api-tabs-content">
                    <!-- Authentication Tab -->
                    <div class="tab-pane fade show active" id="auth-content" role="tabpanel">
                        <div class="api-endpoint">
                            <div class="api-endpoint-header">
                                <div class="api-endpoint-title">
                                    <i class="bi bi-shield-lock me-2"></i>Authentication
                                </div>
                            </div>
                            <div class="api-description">
                                All API endpoints require authentication using a Bearer token. Include the token in
                                the Authorization header of your requests.
                            </div>
                            <div class="api-code-block">
                                <div class="api-code-header">
                                    <span class="api-code-title">Authorization Header</span>
                                    <button class="btn btn-sm btn-outline-primary copy-code"
                                        data-code="Authorization: Bearer YOUR_JWT_TOKEN">
                                        <i class="bi bi-clipboard me-1"></i>Copy
                                    </button>
                                </div>
                                <pre class="api-code"><code>Authorization: Bearer YOUR_JWT_TOKEN</code></pre>
                            </div>
                            <div class="api-info-box">
                                <div class="api-info-title">
                                    <i class="bi bi-info-circle me-2"></i>How to get a token
                                </div>
                                <p>You can obtain a token by logging in to the dashboard. The token is stored in
                                    your browser's local storage.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sessions Tab -->
                    <div class="tab-pane fade" id="sessions-content" role="tabpanel">
                        <div class="api-endpoint">
                            <div class="api-endpoint-header">
                                <div class="api-endpoint-title">
                                    <span class="api-method post">POST</span>
                                    <span class="api-url">/api/create-session</span>
                                </div>
                            </div>
                            <div class="api-description">
                                Create a new WhatsApp session. This endpoint will generate a QR code that you can
                                scan with your WhatsApp mobile app to connect the session.
                            </div>
                            <div class="api-code-block">
                                <div class="api-code-header">
                                    <span class="api-code-title">cURL Example</span>
                                    <button class="btn btn-sm btn-outline-primary copy-code" data-code="curl -X POST \
https://wapiconnect.koyeb.app/api/create-session \
-H 'Authorization: Bearer YOUR_JWT_TOKEN'">
                                        <i class="bi bi-clipboard me-1"></i>Copy
                                    </button>
                                </div>
                                <pre class="api-code"><code>curl -X POST \
https://wapiconnect.koyeb.app/api/create-session \
-H 'Authorization: Bearer YOUR_JWT_TOKEN'</code></pre>
                            </div>
                            <div class="api-response-block">
                                <div class="api-response-header">
                                    <span class="api-response-title">Response</span>
                                </div>
                                <pre class="api-code"><code>{
  "sessionId": "1234567890"
}</code></pre>
                            </div>
                        </div>

                        <div class="api-endpoint mt-4">
                            <div class="api-endpoint-header">
                                <div class="api-endpoint-title">
                                    <span class="api-method get">GET</span>
                                    <span class="api-url">/api/check-sessions</span>
                                </div>
                            </div>
                            <div class="api-description">
                                Get all WhatsApp sessions for the authenticated user. This endpoint returns
                                information about each session, including its status and connected phone number.
                            </div>
                            <div class="api-code-block">
                                <div class="api-code-header">
                                    <span class="api-code-title">cURL Example</span>
                                    <button class="btn btn-sm btn-outline-primary copy-code" data-code="curl -X GET \
https://wapiconnect.koyeb.app/api/check-sessions \
-H 'Authorization: Bearer YOUR_JWT_TOKEN'">
                                        <i class="bi bi-clipboard me-1"></i>Copy
                                    </button>
                                </div>
                                <pre class="api-code"><code>curl -X GET \
https://wapiconnect.koyeb.app/api/check-sessions \
-H 'Authorization: Bearer YOUR_JWT_TOKEN'</code></pre>
                            </div>
                            <div class="api-response-block">
                                <div class="api-response-header">
                                    <span class="api-response-title">Response</span>
                                </div>
                                <pre class="api-code"><code>{
  "sessions": [
    {
      "sessionId": "1234567890",
      "status": "connected",
      "phoneNumber": "+1234567890"
    }
  ]
}</code></pre>
                            </div>
                        </div>

                        <div class="api-endpoint mt-4">
                            <div class="api-endpoint-header">
                                <div class="api-endpoint-title">
                                    <span class="api-method delete">DELETE</span>
                                    <span class="api-url">/api/delete-session/:sessionId</span>
                                </div>
                            </div>
                            <div class="api-description">
                                Delete a WhatsApp session. This will disconnect the session and remove it from your
                                account.
                            </div>
                            <div class="api-params">
                                <div class="api-param">
                                    <div class="api-param-name">sessionId</div>
                                    <div class="api-param-type">string</div>
                                    <div class="api-param-desc">ID of the session to delete</div>
                                </div>
                            </div>
                            <div class="api-code-block">
                                <div class="api-code-header">
                                    <span class="api-code-title">cURL Example</span>
                                    <button class="btn btn-sm btn-outline-primary copy-code" data-code="curl -X DELETE \
https://wapiconnect.koyeb.app/api/delete-session/1234567890 \
-H 'Authorization: Bearer YOUR_JWT_TOKEN'">
                                        <i class="bi bi-clipboard me-1"></i>Copy
                                    </button>
                                </div>
                                <pre class="api-code"><code>curl -X DELETE \
https://wapiconnect.koyeb.app/api/delete-session/1234567890 \
-H 'Authorization: Bearer YOUR_JWT_TOKEN'</code></pre>
                            </div>
                            <div class="api-response-block">
                                <div class="api-response-header">
                                    <span class="api-response-title">Response</span>
                                </div>
                                <pre class="api-code"><code>{
  "success": true
}</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Messaging Tab -->
                    <div class="tab-pane fade" id="messaging-content" role="tabpanel">
                        <div class="api-endpoint">
                            <div class="api-endpoint-header">
                                <div class="api-endpoint-title">
                                    <span class="api-method post">POST</span>
                                    <span class="api-url">/api/send-message</span>
                                </div>
                            </div>
                            <div class="api-description">
                                Send a message to one or more phone numbers. You can include text and optionally an
                                image. The image can be provided as a URL or as base64-encoded data.
                            </div>
                            <div class="api-params">
                                <div class="api-param">
                                    <div class="api-param-name">sessionId</div>
                                    <div class="api-param-type">string</div>
                                    <div class="api-param-desc">ID of the WhatsApp session to use</div>
                                </div>
                                <div class="api-param">
                                    <div class="api-param-name">numbers</div>
                                    <div class="api-param-type">string</div>
                                    <div class="api-param-desc">Phone numbers separated by newlines</div>
                                </div>
                                <div class="api-param">
                                    <div class="api-param-name">message</div>
                                    <div class="api-param-type">string</div>
                                    <div class="api-param-desc">Text message to send</div>
                                </div>
                                <div class="api-param">
                                    <div class="api-param-name">imageData</div>
                                    <div class="api-param-type">object/string</div>
                                    <div class="api-param-desc">Optional. Image URL or base64 data</div>
                                </div>
                            </div>
                            <div class="api-code-block">
                                <div class="api-code-header">
                                    <span class="api-code-title">cURL Example (Text Only)</span>
                                    <button class="btn btn-sm btn-outline-primary copy-code" data-code="curl -X POST \
https://wapiconnect.koyeb.app/api/send-message \
-H 'Authorization: Bearer YOUR_JWT_TOKEN' \
-H 'Content-Type: application/json' \
-d '{
  \" sessionId\": \"1234567890\", \"numbers\": \"+1234567890\\n+9876543210\", \"message\": \"Hello from WhatsApp Bot!\"
                                        }'">
                                        <i class="bi bi-clipboard me-1"></i>Copy
                                    </button>
                                </div>
                                <pre class="api-code"><code>curl -X POST \
https://wapiconnect.koyeb.app/api/send-message \
-H 'Authorization: Bearer YOUR_JWT_TOKEN' \
-H 'Content-Type: application/json' \
-d '{
  "sessionId": "1234567890",
  "numbers": "+1234567890\n+9876543210",
  "message": "Hello from WhatsApp Bot!"
}'</code></pre>
                            </div>
                            <div class="api-code-block mt-3">
                                <div class="api-code-header">
                                    <span class="api-code-title">cURL Example (With Image URL)</span>
                                    <button class="btn btn-sm btn-outline-primary copy-code" data-code="curl -X POST \
https://wapiconnect.koyeb.app/api/send-message \
-H 'Authorization: Bearer YOUR_JWT_TOKEN' \
-H 'Content-Type: application/json' \
-d '{
  \" sessionId\": \"1234567890\", \"numbers\": \"+1234567890\", \"message\": \"Check out this image!\", \"imageData\":
                                        { \"url\": \"https://example.com/image.jpg\" } }'">
                                        <i class="bi bi-clipboard me-1"></i>Copy
                                    </button>
                                </div>
                                <pre class="api-code"><code>curl -X POST \
https://wapiconnect.koyeb.app/api/send-message \
-H 'Authorization: Bearer YOUR_JWT_TOKEN' \
-H 'Content-Type: application/json' \
-d '{
  "sessionId": "1234567890",
  "numbers": "+1234567890",
  "message": "Check out this image!",
  "imageData": {
    "url": "https://example.com/image.jpg"
  }
}'</code></pre>
                            </div>
                            <div class="api-response-block">
                                <div class="api-response-header">
                                    <span class="api-response-title">Response</span>
                                </div>
                                <pre class="api-code"><code>{
  "success": true,
  "results": [
    {
      "number": "+1234567890",
      "success": true
    }
  ]
}</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Contacts Tab -->
                    <div class="tab-pane fade" id="contacts-content" role="tabpanel">
                        <div class="api-endpoint">
                            <div class="api-endpoint-header">
                                <div class="api-endpoint-title">
                                    <span class="api-method post">POST</span>
                                    <span class="api-url">/api/get-contacts</span>
                                </div>
                            </div>
                            <div class="api-description">
                                Retrieve contacts or groups from a WhatsApp session. You can specify whether to
                                include names, status messages, group names, and admin status.
                            </div>
                            <div class="api-params">
                                <div class="api-param">
                                    <div class="api-param-name">sessionId</div>
                                    <div class="api-param-type">string</div>
                                    <div class="api-param-desc">ID of the WhatsApp session to use</div>
                                </div>
                                <div class="api-param">
                                    <div class="api-param-name">source</div>
                                    <div class="api-param-type">string</div>
                                    <div class="api-param-desc">Either "contacts" or "groups"</div>
                                </div>
                                <div class="api-param">
                                    <div class="api-param-name">options</div>
                                    <div class="api-param-type">object</div>
                                    <div class="api-param-desc">Options for what data to include</div>
                                </div>
                            </div>
                            <div class="api-code-block">
                                <div class="api-code-header">
                                    <span class="api-code-title">cURL Example</span>
                                    <button class="btn btn-sm btn-outline-primary copy-code" data-code="curl -X POST \
https://wapiconnect.koyeb.app/api/get-contacts \
-H 'Authorization: Bearer YOUR_JWT_TOKEN' \
-H 'Content-Type: application/json' \
-d '{
  \" sessionId\": \"1234567890\", \"source\": \"contacts\", \"options\": { \"includeName\": true, \"includeStatus\":
                                        true } }'">
                                        <i class="bi bi-clipboard me-1"></i>Copy
                                    </button>
                                </div>
                                <pre class="api-code"><code>curl -X POST \
https://wapiconnect.koyeb.app/api/get-contacts \
-H 'Authorization: Bearer YOUR_JWT_TOKEN' \
-H 'Content-Type: application/json' \
-d '{
  "sessionId": "1234567890",
  "source": "contacts",
  "options": {
    "includeName": true,
    "includeStatus": true
  }
}'</code></pre>
                            </div>
                            <div class="api-response-block">
                                <div class="api-response-header">
                                    <span class="api-response-title">Response</span>
                                </div>
                                <pre class="api-code"><code>{
  "contacts": [
    {
      "phone": "+1234567890",
      "name": "John Doe",
      "status": "Available"
    }
  ]
}</code></pre>
                            </div>
                        </div>

                        <div class="api-endpoint mt-4">
                            <div class="api-endpoint-header">
                                <div class="api-endpoint-title">
                                    <span class="api-method post">POST</span>
                                    <span class="api-url">/api/get-group-members</span>
                                </div>
                            </div>
                            <div class="api-description">
                                Retrieve members of a specific WhatsApp group, including their roles (admin or
                                member).
                            </div>
                            <div class="api-params">
                                <div class="api-param">
                                    <div class="api-param-name">sessionId</div>
                                    <div class="api-param-type">string</div>
                                    <div class="api-param-desc">ID of the WhatsApp session to use</div>
                                </div>
                                <div class="api-param">
                                    <div class="api-param-name">groupId</div>
                                    <div class="api-param-type">string</div>
                                    <div class="api-param-desc">ID of the group to get members from</div>
                                </div>
                            </div>
                            <div class="api-code-block">
                                <div class="api-code-header">
                                    <span class="api-code-title">cURL Example</span>
                                    <button class="btn btn-sm btn-outline-primary copy-code" data-code="curl -X POST \
https://wapiconnect.koyeb.app/api/get-group-members \
-H 'Authorization: Bearer YOUR_JWT_TOKEN' \
-H 'Content-Type: application/json' \
-d '{
  \" sessionId\": \"1234567890\", \"groupId\": \"group-1234567890\" }'">
                                        <i class="bi bi-clipboard me-1"></i>Copy
                                    </button>
                                </div>
                                <pre class="api-code"><code>curl -X POST \
https://wapiconnect.koyeb.app/api/get-group-members \
-H 'Authorization: Bearer YOUR_JWT_TOKEN' \
-H 'Content-Type: application/json' \
-d '{
  "sessionId": "1234567890",
  "groupId": "group-1234567890"
}'</code></pre>
                            </div>
                            <div class="api-response-block">
                                <div class="api-response-header">
                                    <span class="api-response-title">Response</span>
                                </div>
                                <pre class="api-code"><code>{
  "members": [
    {
      "phone": "+1234567890",
      "name": "John Doe",
      "isAdmin": true
    }
  ]
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div class="modal fade" id="create-session-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-qr-code-scan me-2"></i>Create New WhatsApp Session
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="qr-code-container" class="qr-code-container text-center d-none">
                        <h6 class="mb-3">Scan QR Code with WhatsApp</h6>
                        <img id="qr-code" src="" alt="QR Code" class="qr-code">
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Open WhatsApp on your phone and scan this QR code
                            </small>
                        </div>
                    </div>
                    <div id="session-status" class="alert alert-info d-none">
                        <div class="d-flex align-items-center">
                            <div class="loading-spinner me-2"></div>
                            <span>Connecting...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <!-- Toasts will be added here -->
    </div>
    </div>
    <!-- Auto-Reply Rule Modal -->
    <div class="modal fade" id="auto-reply-modal" tabindex="-1" aria-labelledby="auto-reply-modal-label"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="auto-reply-modal-label">
                        <i class="bi bi-reply-all-fill me-2 text-primary"></i>Create Auto-Reply Rule
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="auto-reply-form">
                        <input type="hidden" id="rule-id">

                        <!-- Basic Information -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h6 class="mb-0 text-primary">
                                    <i class="bi bi-info-circle me-2"></i>Basic Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="rule-name" class="form-label fw-medium">Rule Name</label>
                                        <input type="text" class="form-control form-control-lg" id="rule-name"
                                            placeholder="Enter rule name" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="rule-session" class="form-label fw-medium">WhatsApp Session</label>
                                        <select class="form-select form-select-lg" id="rule-session" required>
                                            <option value="">Select a session</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Trigger Settings -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h6 class="mb-0 text-primary">
                                    <i class="bi bi-lightning me-2"></i>Trigger Settings
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="trigger-type" class="form-label fw-medium">Trigger Type</label>
                                        <select class="form-select form-select-lg" id="trigger-type" required>
                                            <option value="keyword">Keyword</option>
                                            <option value="regex">Regular Expression</option>
                                            <option value="exact">Exact Match</option>
                                            <option value="contains">Contains</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="trigger-value" class="form-label fw-medium">Trigger Value</label>
                                        <input type="text" class="form-control form-control-lg" id="trigger-value"
                                            placeholder="Enter trigger text" required>
                                        <div class="form-text text-muted">Enter the text that will trigger this
                                            auto-reply</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Response Settings -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h6 class="mb-0 text-primary">
                                    <i class="bi bi-chat-dots me-2"></i>Response Settings
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label for="response-type" class="form-label fw-medium">Response Type</label>
                                        <select class="form-select form-select-lg" id="response-type" required>
                                            <option value="text">Text</option>
                                            <option value="image">Image with Caption</option>
                                            <option value="template">Template Message</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" id="image-url-container" style="display: none;">
                                        <label for="image-url" class="form-label fw-medium">Image URL</label>
                                        <input type="url" class="form-control form-control-lg" id="image-url"
                                            placeholder="https://example.com/image.jpg">
                                        <div class="form-text text-muted">Required only if response type is "Image with
                                            Caption"</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="response-content" class="form-label fw-medium">Response Content</label>
                                    <textarea class="form-control form-control-lg" id="response-content" rows="3"
                                        placeholder="Enter your response message" required></textarea>
                                    <div class="form-text text-muted">Enter the message that will be sent as a response
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Conditions -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h6 class="mb-0 text-primary">
                                    <i class="bi bi-gear me-2"></i>Advanced Conditions
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Time Restrictions -->
                                <div class="mb-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="time-restricted">
                                        <label class="form-check-label fw-medium" for="time-restricted">Time
                                            Restricted</label>
                                    </div>
                                    <div id="time-conditions" class="mt-3 p-3 bg-light rounded" style="display: none;">
                                        <div class="row g-3 mb-3">
                                            <div class="col-md-6">
                                                <label for="start-time" class="form-label fw-medium">Start Time</label>
                                                <input type="time" class="form-control form-control-lg" id="start-time">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="end-time" class="form-label fw-medium">End Time</label>
                                                <input type="time" class="form-control form-control-lg" id="end-time">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-medium">Days of Week</label>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="0"
                                                        id="day-sun">
                                                    <label class="form-check-label" for="day-sun">Sun</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="1"
                                                        id="day-mon">
                                                    <label class="form-check-label" for="day-mon">Mon</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="2"
                                                        id="day-tue">
                                                    <label class="form-check-label" for="day-tue">Tue</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="3"
                                                        id="day-wed">
                                                    <label class="form-check-label" for="day-wed">Wed</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="4"
                                                        id="day-thu">
                                                    <label class="form-check-label" for="day-thu">Thu</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="5"
                                                        id="day-fri">
                                                    <label class="form-check-label" for="day-fri">Fri</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="6"
                                                        id="day-sat">
                                                    <label class="form-check-label" for="day-sat">Sat</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Restrictions -->
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="contact-restricted">
                                        <label class="form-check-label fw-medium" for="contact-restricted">Contact
                                            Restricted</label>
                                    </div>
                                    <div id="contact-conditions" class="mt-3 p-3 bg-light rounded"
                                        style="display: none;">
                                        <div class="mb-3">
                                            <label for="allowed-contacts" class="form-label fw-medium">Allowed
                                                Contacts</label>
                                            <textarea class="form-control form-control-lg" id="allowed-contacts"
                                                rows="2" placeholder="Enter phone numbers, one per line"></textarea>
                                            <div class="form-text text-muted">Leave empty to allow all contacts</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="excluded-contacts" class="form-label fw-medium">Excluded
                                                Contacts</label>
                                            <textarea class="form-control form-control-lg" id="excluded-contacts"
                                                rows="2" placeholder="Enter phone numbers, one per line"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-lg" id="save-rule-btn">
                        <i class="bi bi-save me-2"></i>Save Rule
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Initialize Bootstrap components
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize all tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Initialize all popovers
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl);
            });

            // Initialize all dropdowns
            var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
            var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl);
            });

            // Initialize all modals
            var modalElementList = [].slice.call(document.querySelectorAll('.modal'));
            var modalList = modalElementList.map(function (modalEl) {
                return new bootstrap.Modal(modalEl);
            });

            // Initialize all tabs
            var tabElementList = [].slice.call(document.querySelectorAll('button[data-bs-toggle="tab"]'));
            var tabList = tabElementList.map(function (tabEl) {
                return new bootstrap.Tab(tabEl);
            });

            // Initialize auto-reply functionality
            initializeAutoReply();
        });

        // Auto-Reply Rules functionality
        function initializeAutoReply() {
            // Load auto-reply rules when the tab is shown
            document.getElementById('auto-reply-tab').addEventListener('shown.bs.tab', function () {
                loadAutoReplyRules();
            });

            // Create rule button
            const createRuleBtn = document.getElementById('create-rule-btn');
            if (createRuleBtn) {
                createRuleBtn.addEventListener('click', function () {
                    resetAutoReplyForm();
                    document.getElementById('auto-reply-modal-label').textContent = 'Create Auto-Reply Rule';
                    document.getElementById('rule-id').value = '';
                    loadSessionsForRule();
                    const modal = new bootstrap.Modal(document.getElementById('auto-reply-modal'));
                    modal.show();
                });
            }

            // Save rule button
            const saveRuleBtn = document.getElementById('save-rule-btn');
            if (saveRuleBtn) {
                saveRuleBtn.addEventListener('click', function () {
                    saveAutoReplyRule();
                });
            }

            // Toggle time restrictions
            const timeRestricted = document.getElementById('time-restricted');
            if (timeRestricted) {
                timeRestricted.addEventListener('change', function () {
                    document.getElementById('time-conditions').style.display = this.checked ? 'block' : 'none';
                });
            }

            // Toggle contact restrictions
            const contactRestricted = document.getElementById('contact-restricted');
            if (contactRestricted) {
                contactRestricted.addEventListener('change', function () {
                    document.getElementById('contact-conditions').style.display = this.checked ? 'block' : 'none';
                });
            }

            // Response type change
            const responseType = document.getElementById('response-type');
            if (responseType) {
                responseType.addEventListener('change', function () {
                    const imageUrlField = document.getElementById('image-url').parentElement;
                    imageUrlField.style.display = this.value === 'image' ? 'block' : 'none';
                });
            }
        }

        // Check authentication
        requireAuth();

        // Display user name
        const user = getCurrentUser();
        document.getElementById('user-name').textContent = user.name;

        // Socket.io connection
        const socket = io();

        // Session management
        let currentSessionId = null;
        const createSessionModal = new bootstrap.Modal(document.getElementById('create-session-modal'));

        // Tab navigation functionality
        document.addEventListener('DOMContentLoaded', function () {
            // Get all navbar tabs
            const navbarTabs = document.querySelectorAll('.navbar-tab');

            // Add click event listener to each tab
            navbarTabs.forEach(tab => {
                tab.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Remove active class from all tabs
                    navbarTabs.forEach(t => t.classList.remove('active'));

                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Get the target tab pane
                    const targetId = this.getAttribute('data-bs-target');
                    const targetPane = document.querySelector(targetId);

                    // Hide all tab panes
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });

                    // Show the target tab pane
                    targetPane.classList.add('show', 'active');
                });
            });
        });

        // Create new session
        document.getElementById('create-session-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/create-session', {
                    method: 'POST',
                    headers: addAuthHeader()
                });

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.sessionId;
                    createSessionModal.show();

                    // Listen for QR code
                    socket.on(`qr-${currentSessionId}`, (qrCode) => {
                        document.getElementById('qr-code').src = qrCode;
                        document.getElementById('qr-code-container').classList.remove('d-none');
                    });

                    // Listen for session status
                    socket.on(`session-${currentSessionId}-status`, (status) => {
                        const statusElement = document.getElementById('session-status');
                        statusElement.innerHTML = `
                            <div class="d-flex align-items-center">
                                <div class="loading-spinner me-2"></div>
                                <span>Status: ${status}</span>
                            </div>
                        `;
                        statusElement.classList.remove('d-none');

                        if (status === 'connected') {
                            setTimeout(() => {
                                createSessionModal.hide();
                                loadSessions();
                                showToast('Session connected successfully!', 'success');
                            }, 2000);
                        }
                    });
                }
            } catch (error) {
                console.error('Error creating session:', error);
                showToast('Error creating session', 'danger');
            }
        });

        // Load sessions
        async function loadSessions() {
            try {
                const response = await fetch('/api/check-sessions', {
                    headers: addAuthHeader()
                });

                const data = await response.json();

                if (response.ok) {
                    const container = document.getElementById('sessions-container');
                    const emptyState = document.getElementById('empty-state');
                    const radioContainer = document.getElementById('session-radio-container');
                    const contactsRadioContainer = document.getElementById('contacts-session-radio-container');
                    container.innerHTML = '';
                    radioContainer.innerHTML = '';
                    contactsRadioContainer.innerHTML = '';

                    // Update stats
                    document.getElementById('total-sessions').textContent = data.sessions.length;
                    document.getElementById('active-sessions').textContent =
                        data.sessions.filter(s => s.status === 'connected').length;

                    if (data.sessions.length === 0) {
                        emptyState.classList.remove('d-none');
                        return;
                    }

                    emptyState.classList.add('d-none');

                    // Create session cards for the Sessions tab
                    data.sessions.forEach(session => {
                        const card = document.createElement('div');
                        card.className = 'col-md-4 mb-4';
                        card.innerHTML = `
                            <div class="session-card">
                                <div class="session-header">
                                    <div class="session-icon">
                                        <i class="bi bi-whatsapp"></i>
                                    </div>
                                    <h5 class="session-title"># ${session.sessionId}</h5>
                                    <button class="session-delete-btn" onclick="deleteSession('${session.sessionId}')" title="Delete Session">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="session-body">
                                    <div class="session-status ${session.status === 'connected' ? 'connected' : 'disconnected'}">
                                        <i class="bi bi-${session.status === 'connected' ? 'check-circle' : 'clock'} me-1"></i>
                                        ${session.status}
                                    </div>
                                    <div class="session-info">
                                        <div class="session-info-item">
                                            <i class="bi bi-phone session-info-icon"></i>
                                            ${session.phoneNumber || 'Not connected'}
                                        </div>
                                        <div class="session-info-item">
                                            <i class="bi bi-clock-history session-info-icon"></i>
                                            Last active: ${new Date().toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);

                        // Create radio buttons for the Bulk Messaging tab
                        const radioDiv = document.createElement('div');
                        radioDiv.className = 'session-radio';
                        radioDiv.innerHTML = `
                            <input type="radio" class="btn-check" name="session-radio" id="session-${session.sessionId}" 
                                value="${session.sessionId}" ${session.status !== 'connected' ? 'disabled' : ''}>
                            <label class="session-radio-label" for="session-${session.sessionId}">
                                <div class="session-radio-icon">
                                    <i class="bi bi-whatsapp"></i>
                                </div>
                                <div class="session-radio-info">
                                    <div class="session-radio-title"># ${session.sessionId}</div>
                                    <div class="session-radio-status">
                                        <i class="bi bi-${session.status === 'connected' ? 'check-circle' : 'clock'} me-1"></i>
                                        ${session.status} - ${session.phoneNumber || 'Not connected'}
                                    </div>
                                </div>
                            </label>
                        `;
                        radioContainer.appendChild(radioDiv);

                        // Create radio buttons for the Contacts tab
                        const contactsRadioDiv = document.createElement('div');
                        contactsRadioDiv.className = 'session-radio';
                        contactsRadioDiv.innerHTML = `
                            <input type="radio" class="btn-check" name="contacts-session-radio" id="contacts-session-${session.sessionId}" 
                                value="${session.sessionId}" ${session.status !== 'connected' ? 'disabled' : ''}>
                            <label class="session-radio-label" for="contacts-session-${session.sessionId}">
                                <div class="session-radio-icon">
                                    <i class="bi bi-whatsapp"></i>
                                </div>
                                <div class="session-radio-info">
                                    <div class="session-radio-title"># ${session.sessionId}</div>
                                    <div class="session-radio-status">
                                        <i class="bi bi-${session.status === 'connected' ? 'check-circle' : 'clock'} me-1"></i>
                                        ${session.status} - ${session.phoneNumber || 'Not connected'}
                                    </div>
                                </div>
                            </label>
                        `;
                        contactsRadioContainer.appendChild(contactsRadioDiv);
                    });
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                showToast('Error loading sessions', 'danger');
            }
        }

        // Delete session
        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) return;

            try {
                const response = await fetch(`/api/delete-session/${sessionId}`, {
                    method: 'DELETE',
                    headers: addAuthHeader()
                });

                if (response.ok) {
                    loadSessions();
                    showToast('Session deleted successfully', 'success');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showToast('Error deleting session', 'danger');
            }
        }

        // Send message
        function openSendMessageModal(sessionId) {
            currentSessionId = sessionId;
            // Switch to bulk messaging tab and select the session
            document.getElementById('bulk-messaging-tab').click();
            document.getElementById(`session-${sessionId}`).checked = true;
        }

        // Image preview functionality for bulk messaging
        document.getElementById('bulk-preview-image').addEventListener('click', () => {
            const imageUrl = document.getElementById('bulk-image-url').value;
            if (imageUrl) {
                const preview = document.getElementById('bulk-image-preview');
                const previewImg = preview.querySelector('img');
                previewImg.src = imageUrl;
                preview.classList.remove('d-none');
            }
        });

        document.getElementById('bulk-preview-upload').addEventListener('click', () => {
            const fileInput = document.getElementById('bulk-image-file');
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('bulk-image-preview');
                    const previewImg = preview.querySelector('img');
                    previewImg.src = e.target.result;
                    preview.classList.remove('d-none');
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        });

        document.getElementById('bulk-remove-image').addEventListener('click', () => {
            document.getElementById('bulk-image-url').value = '';
            document.getElementById('bulk-image-file').value = '';
            document.getElementById('bulk-image-preview').classList.add('d-none');
        });

        // Bulk message form submission
        document.getElementById('bulk-message-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get selected session
            const selectedSession = document.querySelector('input[name="session-radio"]:checked');
            if (!selectedSession) {
                showToast('Please select a session', 'danger');
                return;
            }

            const sessionId = selectedSession.value;
            const numbers = document.getElementById('bulk-phone-numbers').value;
            const message = document.getElementById('bulk-message').value;
            const imageUrl = document.getElementById('bulk-image-url').value;
            const imageFile = document.getElementById('bulk-image-file').files[0];

            // Check if we have an image to send
            let imageData = null;

            if (imageUrl) {
                imageData = { url: imageUrl };
            } else if (imageFile) {
                // Convert file to base64 without compression
                const reader = new FileReader();
                reader.onload = async function (e) {
                    const base64Data = e.target.result.split(',')[1];
                    await sendMessageWithImage(sessionId, numbers, message, base64Data);
                };
                reader.readAsDataURL(imageFile);
                return; // The actual sending will happen in the reader.onload callback
            }

            // If no image or URL image, send message directly
            await sendMessageWithImage(sessionId, numbers, message, imageData);
        });

        // Function to send message with image
        async function sendMessageWithImage(sessionId, numbers, message, imageData) {
            try {
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: addAuthHeader({
                        'Content-Type': 'application/json'
                    }),
                    body: JSON.stringify({
                        sessionId,
                        numbers,
                        message,
                        imageData
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Messages sent successfully!', 'success');
                    document.getElementById('bulk-message-form').reset();
                    document.getElementById('bulk-image-preview').classList.add('d-none');
                } else {
                    showToast('Error sending messages: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Error sending messages:', error);
                showToast('Error sending messages', 'danger');
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Load sessions on page load
        loadSessions();

        // Add event listeners for session radio buttons
        document.addEventListener('change', function (e) {
            if (e.target && e.target.name === 'session-radio') {
                // Remove selected class from all radio buttons
                document.querySelectorAll('.session-radio').forEach(radio => {
                    radio.classList.remove('selected');
                });

                // Add selected class to the clicked radio button
                if (e.target.checked) {
                    e.target.closest('.session-radio').classList.add('selected');
                }
            }

            if (e.target && e.target.name === 'contacts-session-radio') {
                // Remove selected class from all radio buttons
                document.querySelectorAll('.session-radio').forEach(radio => {
                    radio.classList.remove('selected');
                });

                // Add selected class to the clicked radio button
                if (e.target.checked) {
                    e.target.closest('.session-radio').classList.add('selected');
                }
            }
        });

        // Contact source toggle
        document.querySelectorAll('input[name="contactSource"]').forEach(radio => {
            radio.addEventListener('change', function () {
                // No need to toggle visibility of options since they're removed
                // Just update the table headers based on the selected source
                const tableHeaders = document.querySelectorAll('#contacts-results table thead th');
                if (this.value === 'contacts') {
                    tableHeaders[0].textContent = 'Phone Number';
                    tableHeaders[1].textContent = 'Name';
                    tableHeaders[2].textContent = 'Status';
                    tableHeaders[3].textContent = 'Actions';
                } else {
                    tableHeaders[0].textContent = 'Group ID';
                    tableHeaders[1].textContent = 'Group Name';
                    tableHeaders[2].textContent = 'Members';
                    tableHeaders[3].textContent = 'Actions';
                }
            });
        });

        // Contacts form submission
        document.getElementById('contacts-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get selected session
            const selectedSession = document.querySelector('input[name="contacts-session-radio"]:checked');
            if (!selectedSession) {
                showToast('Please select a session', 'danger');
                return;
            }

            const sessionId = selectedSession.value;
            const contactSource = document.querySelector('input[name="contactSource"]:checked').value;

            // All options are enabled by default
            const options = {
                includeName: true,
                includeStatus: true,
                includeGroupName: true,
                includeAdmin: true
            };

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading-spinner me-2"></div>Loading...';
            submitBtn.disabled = true;

            try {
                // Make API call to fetch contacts
                const response = await fetch('/api/get-contacts', {
                    method: 'POST',
                    headers: addAuthHeader({
                        'Content-Type': 'application/json'
                    }),
                    body: JSON.stringify({
                        sessionId,
                        source: contactSource,
                        options
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Display results
                    const tableBody = document.getElementById('contacts-table-body');
                    tableBody.innerHTML = '';

                    if (data.contacts && data.contacts.length > 0) {
                        data.contacts.forEach(contact => {
                            const row = document.createElement('tr');

                            // Different row structure based on contact source
                            if (contactSource === 'contacts') {
                                row.innerHTML = `
                                    <td>${contact.phone || 'N/A'}</td>
                                    <td>${contact.name || 'N/A'}</td>
                                    <td>${contact.status || 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary copy-number" data-number="${contact.phone}">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </td>
                                `;
                            } else {
                                // For groups, show group name and member count
                                row.innerHTML = `
                                    <td>${contact.groupId || 'N/A'}</td>
                                    <td>${contact.groupName || 'N/A'}</td>
                                    <td>${contact.memberCount || 0} members</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary view-members" data-group-id="${contact.groupId}">
                                            <i class="bi bi-people"></i>
                                        </button>
                                    </td>
                                `;
                            }

                            tableBody.appendChild(row);
                        });

                        // Show results container
                        document.getElementById('contacts-results').classList.remove('d-none');

                        showToast(`Successfully loaded ${data.contacts.length} ${contactSource}`, 'success');
                    } else {
                        // Show empty state
                        const tableBody = document.getElementById('contacts-table-body');
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <i class="bi bi-people text-muted" style="font-size: 2rem;"></i>
                                    <p class="mt-2">No ${contactSource} found</p>
                                </td>
                            </tr>
                        `;

                        // Show results container
                        document.getElementById('contacts-results').classList.remove('d-none');
                        showToast(`No ${contactSource} found for this session`, 'info');
                    }
                } else {
                    showToast(`Error: ${data.error || 'Failed to load contacts'}`, 'danger');
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                showToast('Error loading contacts: ' + error.message, 'danger');
            } finally {
                // Reset button
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });

        // View group members
        document.addEventListener('click', function (e) {
            if (e.target.closest('.view-members')) {
                const groupId = e.target.closest('.view-members').getAttribute('data-group-id');
                const selectedSession = document.querySelector('input[name="contacts-session-radio"]:checked');

                if (selectedSession) {
                    const sessionId = selectedSession.value;
                    fetchGroupMembers(sessionId, groupId);
                }
            }
        });

        // Function to fetch group members
        async function fetchGroupMembers(sessionId, groupId) {
            try {
                // Show loading state
                const tableBody = document.getElementById('contacts-table-body');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-2">Loading group members...</p>
                        </td>
                    </tr>
                `;

                // Make API call to fetch group members
                const response = await fetch('/api/get-group-members', {
                    method: 'POST',
                    headers: addAuthHeader({
                        'Content-Type': 'application/json'
                    }),
                    body: JSON.stringify({
                        sessionId,
                        groupId
                    })
                });

                const data = await response.json();

                if (response.ok && data.members) {
                    // Update table headers
                    const tableHeaders = document.querySelectorAll('#contacts-results table thead th');
                    tableHeaders[0].textContent = 'Phone Number';
                    tableHeaders[1].textContent = 'Name';
                    tableHeaders[2].textContent = 'Role';
                    tableHeaders[3].textContent = 'Actions';

                    // Display members
                    tableBody.innerHTML = '';

                    if (data.members.length > 0) {
                        data.members.forEach(member => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${member.phone || 'N/A'}</td>
                                <td>${member.name || 'N/A'}</td>
                                <td>${member.isAdmin ? 'Admin' : 'Member'}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary copy-number" data-number="${member.phone}">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });

                        showToast(`Successfully loaded ${data.members.length} group members`, 'success');
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <i class="bi bi-people text-muted" style="font-size: 2rem;"></i>
                                    <p class="mt-2">No members found in this group</p>
                                </td>
                            </tr>
                        `;
                        showToast('No members found in this group', 'info');
                    }
                } else {
                    showToast(`Error: ${data.error || 'Failed to load group members'}`, 'danger');
                }
            } catch (error) {
                console.error('Error loading group members:', error);
                showToast('Error loading group members: ' + error.message, 'danger');
            }
        }

        // Copy contact number
        document.addEventListener('click', function (e) {
            if (e.target.closest('.copy-number')) {
                const number = e.target.closest('.copy-number').getAttribute('data-number');
                navigator.clipboard.writeText(number).then(() => {
                    showToast('Phone number copied to clipboard', 'success');
                });
            }
        });

        // Copy all contacts
        document.getElementById('copy-contacts').addEventListener('click', function () {
            const rows = document.querySelectorAll('#contacts-table-body tr');
            let numbers = '';

            rows.forEach(row => {
                numbers += row.cells[0].textContent + '\n';
            });

            navigator.clipboard.writeText(numbers).then(() => {
                showToast('All phone numbers copied to clipboard', 'success');
            });
        });

        // Export contacts to CSV
        document.getElementById('export-contacts').addEventListener('click', function () {
            const rows = document.querySelectorAll('#contacts-table-body tr');
            let csv = 'Phone Number,Name,Status\n';

            rows.forEach(row => {
                const cells = row.cells;
                csv += `${cells[0].textContent},${cells[1].textContent},${cells[2].textContent}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'whatsapp-contacts.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            showToast('Contacts exported to CSV', 'success');
        });

        // Copy code functionality for API Docs
        document.addEventListener('DOMContentLoaded', function () {
            const copyButtons = document.querySelectorAll('.copy-code');

            copyButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const codeToCopy = this.getAttribute('data-code');

                    // Create a temporary textarea element
                    const textarea = document.createElement('textarea');
                    textarea.value = codeToCopy;
                    document.body.appendChild(textarea);

                    // Select and copy the text
                    textarea.select();
                    document.execCommand('copy');

                    // Remove the temporary textarea
                    document.body.removeChild(textarea);

                    // Change button text temporarily
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                    }, 2000);
                });
            });
        });

        // Load auto-reply rules
        function loadAutoReplyRules() {
            const tableBody = document.getElementById('auto-reply-rules-table');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';

            fetch('/api/auto-reply-rules', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load auto-reply rules');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.rules.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No auto-reply rules found. Create your first rule to get started.</td></tr>';
                        return;
                    }

                    let html = '';
                    data.rules.forEach(rule => {
                        html += `
                        <tr>
                            <td>${rule.name}</td>
                            <td>${rule.sessionId}</td>
                            <td>
                                <span class="badge bg-info">${rule.triggerType}</span>
                                <small class="text-muted">${rule.triggerValue}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">${rule.responseType}</span>
                                <small class="text-muted">${rule.responseContent.substring(0, 30)}${rule.responseContent.length > 30 ? '...' : ''}</small>
                            </td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input toggle-rule" type="checkbox" data-rule-id="${rule._id}" ${rule.isActive ? 'checked' : ''}>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-rule" data-rule-id="${rule._id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-rule" data-rule-id="${rule._id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    });

                    tableBody.innerHTML = html;

                    // Add event listeners for toggle, edit, and delete buttons
                    document.querySelectorAll('.toggle-rule').forEach(button => {
                        button.addEventListener('change', function () {
                            toggleAutoReplyRule(this.dataset.ruleId);
                        });
                    });

                    document.querySelectorAll('.edit-rule').forEach(button => {
                        button.addEventListener('click', function () {
                            editAutoReplyRule(this.dataset.ruleId);
                        });
                    });

                    document.querySelectorAll('.delete-rule').forEach(button => {
                        button.addEventListener('click', function () {
                            deleteAutoReplyRule(this.dataset.ruleId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading auto-reply rules:', error);
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Failed to load auto-reply rules. Please try again later.</td></tr>';
                });
        }

        // Load sessions for the rule form
        function loadSessionsForRule() {
            const sessionSelect = document.getElementById('rule-session');
            sessionSelect.innerHTML = '<option value="">Select a session</option>';

            fetch('/api/check-sessions', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load sessions');
                    }
                    return response.json();
                })
                .then(data => {
                    data.sessions.forEach(session => {
                        if (session.status === 'connected') {
                            const option = document.createElement('option');
                            option.value = session.sessionId;
                            option.textContent = `${session.sessionId} (${session.phoneNumber || 'No phone number'})`;
                            sessionSelect.appendChild(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading sessions:', error);
                });
        }

        // Save auto-reply rule
        function saveAutoReplyRule() {
            const ruleId = document.getElementById('rule-id').value;
            const isEdit = ruleId !== '';

            // Get form values
            const name = document.getElementById('rule-name').value;
            const sessionId = document.getElementById('rule-session').value;
            const triggerType = document.getElementById('trigger-type').value;
            const triggerValue = document.getElementById('trigger-value').value;
            const responseType = document.getElementById('response-type').value;
            const responseContent = document.getElementById('response-content').value;
            const imageUrl = document.getElementById('image-url').value;

            // Get conditions
            const timeRestricted = document.getElementById('time-restricted').checked;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const daysOfWeek = Array.from(document.querySelectorAll('input[id^="day-"]:checked')).map(cb => parseInt(cb.value));

            const contactRestricted = document.getElementById('contact-restricted').checked;
            const allowedContacts = document.getElementById('allowed-contacts').value.split('\n').map(n => n.trim()).filter(n => n);
            const excludedContacts = document.getElementById('excluded-contacts').value.split('\n').map(n => n.trim()).filter(n => n);

            // Validate form
            if (!name || !sessionId || !triggerValue || !responseContent) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            if (responseType === 'image' && !imageUrl) {
                showToast('Image URL is required for image response type', 'error');
                return;
            }

            // Prepare request data
            const ruleData = {
                name,
                sessionId,
                triggerType,
                triggerValue,
                responseType,
                responseContent,
                imageUrl: responseType === 'image' ? imageUrl : null,
                conditions: {
                    timeRestricted,
                    startTime: timeRestricted ? startTime : null,
                    endTime: timeRestricted ? endTime : null,
                    daysOfWeek: timeRestricted && daysOfWeek.length > 0 ? daysOfWeek : [],
                    contactRestricted,
                    allowedContacts: contactRestricted ? allowedContacts : [],
                    excludedContacts: contactRestricted ? excludedContacts : []
                }
            };

            // Determine endpoint and method
            const url = isEdit ? `/api/auto-reply-rules/${ruleId}` : '/api/auto-reply-rules';
            const method = isEdit ? 'PUT' : 'POST';

            // Send request
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(ruleData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to save auto-reply rule');
                    }
                    return response.json();
                })
                .then(data => {
                    bootstrap.Modal.getInstance(document.getElementById('auto-reply-modal')).hide();
                    showToast(`Auto-reply rule ${isEdit ? 'updated' : 'created'} successfully`, 'success');
                    loadAutoReplyRules();
                })
                .catch(error => {
                    console.error('Error saving auto-reply rule:', error);
                    showToast('Failed to save auto-reply rule', 'error');
                });
        }

        // Edit auto-reply rule
        function editAutoReplyRule(ruleId) {
            fetch(`/api/auto-reply-rules/${ruleId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load rule details');
                    }
                    return response.json();
                })
                .then(data => {
                    const rule = data.rule;

                    // Set form values
                    document.getElementById('rule-id').value = rule._id;
                    document.getElementById('rule-name').value = rule.name;
                    document.getElementById('trigger-type').value = rule.triggerType;
                    document.getElementById('trigger-value').value = rule.triggerValue;
                    document.getElementById('response-type').value = rule.responseType;
                    document.getElementById('response-content').value = rule.responseContent;
                    document.getElementById('image-url').value = rule.imageUrl || '';

                    // Set conditions
                    document.getElementById('time-restricted').checked = rule.conditions.timeRestricted;
                    document.getElementById('time-conditions').style.display = rule.conditions.timeRestricted ? 'block' : 'none';

                    if (rule.conditions.timeRestricted) {
                        document.getElementById('start-time').value = rule.conditions.startTime || '';
                        document.getElementById('end-time').value = rule.conditions.endTime || '';

                        // Set days of week
                        document.querySelectorAll('input[id^="day-"]').forEach(cb => {
                            cb.checked = rule.conditions.daysOfWeek.includes(parseInt(cb.value));
                        });
                    }

                    document.getElementById('contact-restricted').checked = rule.conditions.contactRestricted;
                    document.getElementById('contact-conditions').style.display = rule.conditions.contactRestricted ? 'block' : 'none';

                    if (rule.conditions.contactRestricted) {
                        document.getElementById('allowed-contacts').value = rule.conditions.allowedContacts.join('\n');
                        document.getElementById('excluded-contacts').value = rule.conditions.excludedContacts.join('\n');
                    }

                    // Show/hide image URL field based on response type
                    document.getElementById('image-url').parentElement.style.display = rule.responseType === 'image' ? 'block' : 'none';

                    // Load sessions and set the selected session
                    loadSessionsForRule().then(() => {
                        document.getElementById('rule-session').value = rule.sessionId;
                    });

                    // Update modal title
                    document.getElementById('auto-reply-modal-label').textContent = 'Edit Auto-Reply Rule';

                    // Show modal
                    new bootstrap.Modal(document.getElementById('auto-reply-modal')).show();
                })
                .catch(error => {
                    console.error('Error loading rule details:', error);
                    showToast('Failed to load rule details', 'error');
                });
        }

        // Delete auto-reply rule
        function deleteAutoReplyRule(ruleId) {
            if (!confirm('Are you sure you want to delete this auto-reply rule?')) {
                return;
            }

            fetch(`/api/auto-reply-rules/${ruleId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete auto-reply rule');
                    }
                    return response.json();
                })
                .then(data => {
                    showToast('Auto-reply rule deleted successfully', 'success');
                    loadAutoReplyRules();
                })
                .catch(error => {
                    console.error('Error deleting auto-reply rule:', error);
                    showToast('Failed to delete auto-reply rule', 'error');
                });
        }

        // Toggle auto-reply rule
        function toggleAutoReplyRule(ruleId) {
            fetch(`/api/auto-reply-rules/${ruleId}/toggle`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to toggle auto-reply rule');
                    }
                    return response.json();
                })
                .then(data => {
                    const isActive = data.rule.isActive;
                    showToast(`Auto-reply rule ${isActive ? 'activated' : 'deactivated'}`, 'success');
                })
                .catch(error => {
                    console.error('Error toggling auto-reply rule:', error);
                    showToast('Failed to toggle auto-reply rule', 'error');
                    // Reload rules to reset the toggle state
                    loadAutoReplyRules();
                });
        }

        // Reset auto-reply form
        function resetAutoReplyForm() {
            document.getElementById('auto-reply-form').reset();
            document.getElementById('time-conditions').style.display = 'none';
            document.getElementById('contact-conditions').style.display = 'none';
            document.getElementById('image-url').parentElement.style.display = 'none';
        }

        // Update the JavaScript to fix the save button visibility issue
        document.addEventListener('DOMContentLoaded', function () {
            // Response type change handler
            const responseType = document.getElementById('response-type');
            const imageUrlContainer = document.getElementById('image-url-container');

            if (responseType) {
                responseType.addEventListener('change', function () {
                    if (this.value === 'image') {
                        imageUrlContainer.style.display = 'block';
                        document.getElementById('image-url').required = true;
                    } else {
                        imageUrlContainer.style.display = 'none';
                        document.getElementById('image-url').required = false;
                    }
                });
            }

            // Time restricted toggle handler
            const timeRestricted = document.getElementById('time-restricted');
            const timeConditions = document.getElementById('time-conditions');

            if (timeRestricted) {
                timeRestricted.addEventListener('change', function () {
                    timeConditions.style.display = this.checked ? 'block' : 'none';
                });
            }

            // Contact restricted toggle handler
            const contactRestricted = document.getElementById('contact-restricted');
            const contactConditions = document.getElementById('contact-conditions');

            if (contactRestricted) {
                contactRestricted.addEventListener('change', function () {
                    contactConditions.style.display = this.checked ? 'block' : 'none';
                });
            }
        });
    </script>

</body>

</html>